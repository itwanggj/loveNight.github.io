
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Python 3 多线程下载百度图片搜索结果 | 岁月如歌</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="LoveNight">
    

    
    <meta name="description" content="记录百度图片搜索脚本的研究过程，下载长者图片，提升姿势水平。代码仍有不足，还要再学习一个！">
<meta property="og:type" content="article">
<meta property="og:title" content="Python 3 多线程下载百度图片搜索结果">
<meta property="og:url" content="http://lovenight.github.io/2015/11/15/Python-3-多线程下载百度图片搜索结果/index.html">
<meta property="og:site_name" content="岁月如歌">
<meta property="og:description" content="记录百度图片搜索脚本的研究过程，下载长者图片，提升姿势水平。代码仍有不足，还要再学习一个！">
<meta property="og:image" content="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E4%BB%96.png">
<meta property="og:image" content="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E4%B8%8B%E8%BD%BD%E7%BB%93%E6%9E%9C1.png">
<meta property="og:image" content="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9CF12.png">
<meta property="og:image" content="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9CRequestURL.png">
<meta property="og:image" content="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E6%96%87%E6%9C%AC%E5%AF%B9%E6%AF%94%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E4%B8%AD%E6%96%87%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81.png">
<meta property="og:image" content="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9CResponse.png">
<meta property="og:image" content="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9CJSON%20Handle.png">
<meta property="og:image" content="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E5%8D%95%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%BB%93%E6%9E%9C.png">
<meta property="og:updated_time" content="2015-11-15T11:50:38.403Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Python 3 多线程下载百度图片搜索结果">
<meta name="twitter:description" content="记录百度图片搜索脚本的研究过程，下载长者图片，提升姿势水平。代码仍有不足，还要再学习一个！">

    
    <link rel="alternative" href="/atom.xml" title="岁月如歌" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="岁月如歌" title="岁月如歌"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="岁月如歌">岁月如歌</a></h1>
				<h2 class="blog-motto">莫厌追欢笑语频，寻思离乱好伤神。闲来屈指从头数，得见清平有几人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/Android">Android</a></li>
					
						<li><a href="/Python">Python</a></li>
					
						<li><a href="/API">API</a></li>
					
						<li><a href="/About">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:lovenight.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/15/Python-3-多线程下载百度图片搜索结果/" title="Python 3 多线程下载百度图片搜索结果" itemprop="url">Python 3 多线程下载百度图片搜索结果</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="LoveNight" target="_blank" itemprop="author">LoveNight</a>
		
  <p class="article-time">
    <time datetime="2015-11-15T10:58:36.000Z" itemprop="datePublished"> 发表于 2015-11-15</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#下载简单页面"><span class="toc-number">1.</span> <span class="toc-text">下载简单页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载更多图片"><span class="toc-number">2.</span> <span class="toc-text">加载更多图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#单线程下载脚本"><span class="toc-number">3.</span> <span class="toc-text">单线程下载脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多线程下载脚本"><span class="toc-number">4.</span> <span class="toc-text">多线程下载脚本</span></a></li></ol>
		
		</div>
		
		<p>今天来搜一搜「他」：<a href="http://www.baidu.com/s?wd=%E9%95%BF%E8%80%85%E8%9B%A4&amp;tn=87048150_dg&amp;ie=utf8" target="_blank" rel="external">百度图片搜索结果</a>。<br><img src="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E4%BB%96.png" alt="搜索结果"></p>
<h2 id="下载简单页面">下载简单页面</h2><p>查看网页源码，发现同一张图片有四种网址：</p>
<pre><code>"thumbURL": "http://img1.imgtn.bdimg.com/it/u=<span class="number">757023778</span>,<span class="number">2840825931</span>&amp;fm=21&amp;gp=0.jpg",
"middleURL": "http://img1.imgtn.bdimg.com/it/u=<span class="number">757023778</span>,<span class="number">2840825931</span>&amp;fm=21&amp;gp=0.jpg",
"hoverURL": "http://img1.imgtn.bdimg.com/it/u=<span class="number">757023778</span>,<span class="number">2840825931</span>&amp;fm=23&amp;gp=0.jpg",
"objURL": "http://imgsrc.baidu.com/forum/w=580/sign=b3bcc<span class="number">2f88a5494</span>ee<span class="number">87220f111</span>df<span class="number">4e0e1/78</span>fed309b3de<span class="number">9c82913</span>abac<span class="number">86a81800a18</span>d84344.jpg",
</code></pre><p>经测试，前三种都有反爬虫措施，用浏览器可以打开，但是刷新一次就403 Forbidden。用爬虫获取不到图片。</p>
<p>第四种objURL是指图片的源网址，获取该网址会出现三种情况：</p>
<ol>
<li>正常。继续下载</li>
<li>403 Forbidden。用continue跳过。</li>
<li>出现异常。用try except处理。</li>
</ol>
<p>代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">url = <span class="string">r'http://image.baidu.com/search/index?tn=baiduimage&amp;ipn=r&amp;ct=201326592&amp;cl=2&amp;lm=-1&amp;st=-1&amp;fm=detail&amp;fr=&amp;sf=1&amp;fmq=1447473655189_R&amp;pv=&amp;ic=0&amp;nc=1&amp;z=&amp;se=&amp;showtab=0&amp;fb=0&amp;width=&amp;height=&amp;face=0&amp;istype=2&amp;ie=utf-8&amp;word=%E9%95%BF%E8%80%85%E8%9B%A4'</span></span><br><span class="line">dirpath = <span class="string">r'F:\img'</span></span><br><span class="line"></span><br><span class="line">html = requests.get(url).text</span><br><span class="line">urls = re.findall(<span class="string">r'"objURL":"(.*?)"'</span>, html)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(dirpath):</span><br><span class="line">    os.mkdir(dirpath)</span><br><span class="line"></span><br><span class="line">index = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">    print(<span class="string">"Downloading:"</span>, url)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = requests.get(url)</span><br><span class="line">        <span class="keyword">if</span> str(res.status_code)[<span class="number">0</span>] == <span class="string">"4"</span>:</span><br><span class="line">            print(<span class="string">"未下载成功："</span>, url)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">"未下载成功："</span>, url)</span><br><span class="line">    filename = os.path.join(dirpath, str(index) + <span class="string">".jpg"</span>)</span><br><span class="line">    <span class="keyword">with</span> open(filename, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(res.content)</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"下载结束，一共 %s 张图片"</span> % index)</span><br></pre></td></tr></table></figure>
<p><img src="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E4%B8%8B%E8%BD%BD%E7%BB%93%E6%9E%9C1.png" alt="下载结果"></p>
<p>Exciting！</p>
<h2 id="加载更多图片">加载更多图片</h2><p>但是上面的代码还有不足，当我们在网页中下拉时，百度会继续加载更多图片。需要再完善一下代码。</p>
<p>打开Chrome，按F12，切换到Network标签，然后将网页向下拉。这时浏览器地址栏的网址并没有改变，而网页中的图片却一张张增加，说明网页在后台与服务器交互数据。警察蜀黍，就是这家伙：<br><img src="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9CF12.png" alt="Chrome 抓包"></p>
<p>xhr全称XMLHttpRequest，详细介绍见百度：<a href="http://baike.baidu.com/link?url=59cVUdY8JuhiQ1NBfELSH93H_HFlTg9YoC5cqnjuyIvVHcyqx92fVNLTUWfvq8lesK5-h9HXgmbVuQseom0qu_" target="_blank" rel="external">XMLHTTPRequest_百度百科</a></p>
<p>点开看看：<br><img src="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9CRequestURL.png" alt="Request URL"></p>
<p>这么长一串网址，没有头绪。下拉网页，再抓一个xhr，对比一下它们的Request URL，使用在线文字对比工具：<a href="http://home.putclub.com/tools/find/" target="_blank" rel="external">文本比较</a><br><img src="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E6%96%87%E6%9C%AC%E5%AF%B9%E6%AF%94%E7%BB%93%E6%9E%9C.png" alt="文本对比结果"></p>
<p>URL末尾有三处变化，最后一项看上去是时间戳，经过测试，直接把它删了也没事。</p>
<p>那么只需要研究<code>pn</code>和<code>gsm</code>值。继续下拉，到底的时候点<code>加载更多图片</code>，多抓几个对比一下URL的末尾部分：</p>
<pre><code>pn=<span class="number">120</span>&amp;rn=<span class="number">60</span>&amp;gsm=<span class="number">78</span>
pn=<span class="number">180</span>&amp;rn=<span class="number">60</span>&amp;gsm=b4
pn=<span class="number">240</span>&amp;rn=<span class="number">60</span>&amp;gsm=f0
pn=<span class="number">300</span>&amp;rn=<span class="number">60</span>&amp;gsm=<span class="number">12</span>c
pn=<span class="number">360</span>&amp;rn=<span class="number">60</span>&amp;gsm=<span class="number">168</span>
</code></pre><p><code>pn</code>是一个60为步长的等差数列。<code>gsm</code>看上去是16进制，转换成十进制，发现它就是<code>pn</code>值，试了也可以删掉。</p>
<p>经测试，<code>rn</code>是步长值，最大只能取60，填入大于60的数，仍然以60为步长。如果删了<code>rn</code>，则步长值变为30。<code>pn</code>是图片编号，从0开始。</p>
<p>现在已经删了时间戳和<code>gsm</code>两项了，能不能让网址再短一点？继续观察，注意到：</p>
<pre><code>&amp;se=&amp;tab=&amp;<span class="variable">width</span>=&amp;<span class="variable">height</span>=
</code></pre><p>这几项没指定值，肯定没用，把没值的都删了。</p>
<p>再看看这两项：</p>
<pre><code>queryWord=<span class="preprocessor">%</span>E<span class="number">9</span><span class="preprocessor">%</span><span class="number">95</span><span class="preprocessor">%</span>BF<span class="preprocessor">%</span>E<span class="number">8</span><span class="preprocessor">%</span><span class="number">80</span><span class="preprocessor">%</span><span class="number">85</span><span class="preprocessor">%</span>E<span class="number">8</span><span class="preprocessor">%</span><span class="number">9</span>B<span class="preprocessor">%</span>A<span class="number">4</span>
word=<span class="preprocessor">%</span>E<span class="number">9</span><span class="preprocessor">%</span><span class="number">95</span><span class="preprocessor">%</span>BF<span class="preprocessor">%</span>E<span class="number">8</span><span class="preprocessor">%</span><span class="number">80</span><span class="preprocessor">%</span><span class="number">85</span><span class="preprocessor">%</span>E<span class="number">8</span><span class="preprocessor">%</span><span class="number">9</span>B<span class="preprocessor">%</span>A<span class="number">4</span>
</code></pre><p>这就是我们本次搜索的关键词。网址中的中文会被编码成UTF-8，每个中文3个字节，每个字节前加上%号。编码和解码方法如下：<br><img src="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E4%B8%AD%E6%96%87%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81.png" alt="中文编码解码"></p>
<p>那么，我们可以写出指定关键词需要请求的所有网址：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buildUrls</span><span class="params">(word)</span>:</span></span><br><span class="line">    word = urllib.parse.quote(word)</span><br><span class="line">    url = <span class="string">r"http://image.baidu.com/search/acjson?tn=resultjson_com&amp;ipn=rj&amp;ct=201326592&amp;fp=result&amp;queryWord=&#123;word&#125;&amp;cl=2&amp;lm=-1&amp;ie=utf-8&amp;oe=utf-8&amp;st=-1&amp;ic=0&amp;word=&#123;word&#125;&amp;face=0&amp;istype=2nc=1&amp;pn=&#123;pn&#125;&amp;rn=60"</span></span><br><span class="line">    urls = (url.format(word=word, pn=x) <span class="keyword">for</span> x <span class="keyword">in</span> itertools.count(start=<span class="number">0</span>, step=<span class="number">60</span>))</span><br><span class="line">    <span class="keyword">return</span> urls</span><br></pre></td></tr></table></figure></p>
<p>上面的代码中，itertools.count(start=0, step=60)表示一个从0开始，60为步长值的无限等差数列。<br>把这个数列的数字分别填入url作为pn值，就得到一个无限容量的url生成器，注意生成器必须用圆括号，如果写成中括号就成了列表，程序会在这一步无限执行下去。</p>
<p>下面开始解析每次获取的数据。我们点开看看，返回的是一串json数据。<br><img src="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9CResponse.png" alt="接口返回数据"></p>
<p>纳尼，这个objURL怎么不是HTTP开头的。试了几种方法都没成功，Google一下，找到这个：<a href="http://blog.csdn.net/hbuxiaoshe/article/details/44780653" target="_blank" rel="external">百度图片url解码</a></p>
<p>OK，既然明白了原理，我们写一个Python版的解密实现：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author: loveNight</span></span><br><span class="line"><span class="comment"># @Date:   2015-11-14 21:11:11</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""解码百度图片搜索json中传递的url</span><br><span class="line">抓包可以获取加载更多图片时，服务器向网址传输的json。</span><br><span class="line">其中originURL是特殊的字符串</span><br><span class="line">解码前：</span><br><span class="line">ippr_z2C$qAzdH3FAzdH3Ffl_z&amp;e3Bftgwt42_z&amp;e3BvgAzdH3F4omlaAzdH3Faa8W3ZyEpymRmx3Y1p7bb&amp;mla</span><br><span class="line">解码后：</span><br><span class="line">http://s9.sinaimg.cn/mw690/001WjZyEty6R6xjYdtu88&amp;690</span><br><span class="line">使用下面两张映射表进行解码。</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line">str_table = &#123;</span><br><span class="line">    <span class="string">'_z2C$q'</span>: <span class="string">':'</span>,</span><br><span class="line">    <span class="string">'_z&amp;e3B'</span>: <span class="string">'.'</span>,</span><br><span class="line">    <span class="string">'AzdH3F'</span>: <span class="string">'/'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">char_table = &#123;</span><br><span class="line">    <span class="string">'w'</span>: <span class="string">'a'</span>,</span><br><span class="line">    <span class="string">'k'</span>: <span class="string">'b'</span>,</span><br><span class="line">    <span class="string">'v'</span>: <span class="string">'c'</span>,</span><br><span class="line">    <span class="string">'1'</span>: <span class="string">'d'</span>,</span><br><span class="line">    <span class="string">'j'</span>: <span class="string">'e'</span>,</span><br><span class="line">    <span class="string">'u'</span>: <span class="string">'f'</span>,</span><br><span class="line">    <span class="string">'2'</span>: <span class="string">'g'</span>,</span><br><span class="line">    <span class="string">'i'</span>: <span class="string">'h'</span>,</span><br><span class="line">    <span class="string">'t'</span>: <span class="string">'i'</span>,</span><br><span class="line">    <span class="string">'3'</span>: <span class="string">'j'</span>,</span><br><span class="line">    <span class="string">'h'</span>: <span class="string">'k'</span>,</span><br><span class="line">    <span class="string">'s'</span>: <span class="string">'l'</span>,</span><br><span class="line">    <span class="string">'4'</span>: <span class="string">'m'</span>,</span><br><span class="line">    <span class="string">'g'</span>: <span class="string">'n'</span>,</span><br><span class="line">    <span class="string">'5'</span>: <span class="string">'o'</span>,</span><br><span class="line">    <span class="string">'r'</span>: <span class="string">'p'</span>,</span><br><span class="line">    <span class="string">'q'</span>: <span class="string">'q'</span>,</span><br><span class="line">    <span class="string">'6'</span>: <span class="string">'r'</span>,</span><br><span class="line">    <span class="string">'f'</span>: <span class="string">'s'</span>,</span><br><span class="line">    <span class="string">'p'</span>: <span class="string">'t'</span>,</span><br><span class="line">    <span class="string">'7'</span>: <span class="string">'u'</span>,</span><br><span class="line">    <span class="string">'e'</span>: <span class="string">'v'</span>,</span><br><span class="line">    <span class="string">'o'</span>: <span class="string">'w'</span>,</span><br><span class="line">    <span class="string">'8'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'d'</span>: <span class="string">'2'</span>,</span><br><span class="line">    <span class="string">'n'</span>: <span class="string">'3'</span>,</span><br><span class="line">    <span class="string">'9'</span>: <span class="string">'4'</span>,</span><br><span class="line">    <span class="string">'c'</span>: <span class="string">'5'</span>,</span><br><span class="line">    <span class="string">'m'</span>: <span class="string">'6'</span>,</span><br><span class="line">    <span class="string">'0'</span>: <span class="string">'7'</span>,</span><br><span class="line">    <span class="string">'b'</span>: <span class="string">'8'</span>,</span><br><span class="line">    <span class="string">'l'</span>: <span class="string">'9'</span>,</span><br><span class="line">    <span class="string">'a'</span>: <span class="string">'0'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># str 的translate方法需要用单个字符的十进制unicode编码作为key</span></span><br><span class="line"><span class="comment"># value 中的数字会被当成十进制unicode编码转换成字符</span></span><br><span class="line"><span class="comment"># 也可以直接用字符串作为value</span></span><br><span class="line">char_table = &#123;ord(key): ord(value) <span class="keyword">for</span> key, value <span class="keyword">in</span> char_table.items()&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="comment"># 先替换字符串</span></span><br><span class="line">    <span class="keyword">for</span> key, value <span class="keyword">in</span> str_table.items():</span><br><span class="line">        url = url.replace(key, value)</span><br><span class="line">    <span class="comment"># 再替换剩下的字符</span></span><br><span class="line">    <span class="keyword">return</span> url.translate(char_table)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    url = <span class="string">r"ippr_z2C$qAzdH3FAzdH3Ffl_z&amp;e3Bftgwt42_z&amp;e3BvgAzdH3F4omlaAzdH3Faa8W3ZyEpymRmx3Y1p7bb&amp;mla"</span></span><br><span class="line">    print(decode(url))</span><br></pre></td></tr></table></figure></p>
<p>测试成功！</p>
<p>再从JSON字符串中找出所有的originURL：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">re_url = re.compile(<span class="string">r'"objURL":"(.*?)"'</span>)</span><br><span class="line">imgs = re_url.findall(html)</span><br></pre></td></tr></table></figure></p>
<p>格式化JSON推荐使用Chrome的<a href="https://chrome.google.com/webstore/detail/iahnhfdhidomcpggpaimmmahffihkfnj" target="_blank" rel="external">JSON handle插件</a><br><img src="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9CJSON%20Handle.png" alt="JSON hanlde插件效果"></p>
<h2 id="单线程下载脚本">单线程下载脚本</h2><p>整理一下流程：</p>
<ol>
<li>生成网址列表</li>
<li>发送HTTP请求获取json数据</li>
<li>解析数据得到网址</li>
<li>下载</li>
</ol>
<p>整合一下上面的代码，可以写出单线程的下载脚本：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author: loveNight</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">str_table = &#123;</span><br><span class="line">    <span class="string">'_z2C$q'</span>: <span class="string">':'</span>,</span><br><span class="line">    <span class="string">'_z&amp;e3B'</span>: <span class="string">'.'</span>,</span><br><span class="line">    <span class="string">'AzdH3F'</span>: <span class="string">'/'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">char_table = &#123;</span><br><span class="line">    <span class="string">'w'</span>: <span class="string">'a'</span>,</span><br><span class="line">    <span class="string">'k'</span>: <span class="string">'b'</span>,</span><br><span class="line">    <span class="string">'v'</span>: <span class="string">'c'</span>,</span><br><span class="line">    <span class="string">'1'</span>: <span class="string">'d'</span>,</span><br><span class="line">    <span class="string">'j'</span>: <span class="string">'e'</span>,</span><br><span class="line">    <span class="string">'u'</span>: <span class="string">'f'</span>,</span><br><span class="line">    <span class="string">'2'</span>: <span class="string">'g'</span>,</span><br><span class="line">    <span class="string">'i'</span>: <span class="string">'h'</span>,</span><br><span class="line">    <span class="string">'t'</span>: <span class="string">'i'</span>,</span><br><span class="line">    <span class="string">'3'</span>: <span class="string">'j'</span>,</span><br><span class="line">    <span class="string">'h'</span>: <span class="string">'k'</span>,</span><br><span class="line">    <span class="string">'s'</span>: <span class="string">'l'</span>,</span><br><span class="line">    <span class="string">'4'</span>: <span class="string">'m'</span>,</span><br><span class="line">    <span class="string">'g'</span>: <span class="string">'n'</span>,</span><br><span class="line">    <span class="string">'5'</span>: <span class="string">'o'</span>,</span><br><span class="line">    <span class="string">'r'</span>: <span class="string">'p'</span>,</span><br><span class="line">    <span class="string">'q'</span>: <span class="string">'q'</span>,</span><br><span class="line">    <span class="string">'6'</span>: <span class="string">'r'</span>,</span><br><span class="line">    <span class="string">'f'</span>: <span class="string">'s'</span>,</span><br><span class="line">    <span class="string">'p'</span>: <span class="string">'t'</span>,</span><br><span class="line">    <span class="string">'7'</span>: <span class="string">'u'</span>,</span><br><span class="line">    <span class="string">'e'</span>: <span class="string">'v'</span>,</span><br><span class="line">    <span class="string">'o'</span>: <span class="string">'w'</span>,</span><br><span class="line">    <span class="string">'8'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'d'</span>: <span class="string">'2'</span>,</span><br><span class="line">    <span class="string">'n'</span>: <span class="string">'3'</span>,</span><br><span class="line">    <span class="string">'9'</span>: <span class="string">'4'</span>,</span><br><span class="line">    <span class="string">'c'</span>: <span class="string">'5'</span>,</span><br><span class="line">    <span class="string">'m'</span>: <span class="string">'6'</span>,</span><br><span class="line">    <span class="string">'0'</span>: <span class="string">'7'</span>,</span><br><span class="line">    <span class="string">'b'</span>: <span class="string">'8'</span>,</span><br><span class="line">    <span class="string">'l'</span>: <span class="string">'9'</span>,</span><br><span class="line">    <span class="string">'a'</span>: <span class="string">'0'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># str 的translate方法需要用单个字符的十进制unicode编码作为key</span></span><br><span class="line"><span class="comment"># value 中的数字会被当成十进制unicode编码转换成字符</span></span><br><span class="line"><span class="comment"># 也可以直接用字符串作为value</span></span><br><span class="line">char_table = &#123;ord(key): ord(value) <span class="keyword">for</span> key, value <span class="keyword">in</span> char_table.items()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解码图片URL</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="comment"># 先替换字符串</span></span><br><span class="line">    <span class="keyword">for</span> key, value <span class="keyword">in</span> str_table.items():</span><br><span class="line">        url = url.replace(key, value)</span><br><span class="line">    <span class="comment"># 再替换剩下的字符</span></span><br><span class="line">    <span class="keyword">return</span> url.translate(char_table)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成网址列表</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buildUrls</span><span class="params">(word)</span>:</span></span><br><span class="line">    word = urllib.parse.quote(word)</span><br><span class="line">    url = <span class="string">r"http://image.baidu.com/search/acjson?tn=resultjson_com&amp;ipn=rj&amp;ct=201326592&amp;fp=result&amp;queryWord=&#123;word&#125;&amp;cl=2&amp;lm=-1&amp;ie=utf-8&amp;oe=utf-8&amp;st=-1&amp;ic=0&amp;word=&#123;word&#125;&amp;face=0&amp;istype=2nc=1&amp;pn=&#123;pn&#125;&amp;rn=60"</span></span><br><span class="line">    urls = (url.format(word=word, pn=x) <span class="keyword">for</span> x <span class="keyword">in</span> itertools.count(start=<span class="number">0</span>, step=<span class="number">60</span>))</span><br><span class="line">    <span class="keyword">return</span> urls</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析JSON获取图片URL</span></span><br><span class="line">re_url = re.compile(<span class="string">r'"objURL":"(.*?)"'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resolveImgUrl</span><span class="params">(html)</span>:</span></span><br><span class="line">    imgUrls = [decode(x) <span class="keyword">for</span> x <span class="keyword">in</span> re_url.findall(html)]</span><br><span class="line">    <span class="keyword">return</span> imgUrls</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">downImg</span><span class="params">(imgUrl, dirpath, imgName)</span>:</span></span><br><span class="line">    filename = os.path.join(dirpath, imgName)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = requests.get(imgUrl, timeout=<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">if</span> str(res.status_code)[<span class="number">0</span>] == <span class="string">"4"</span>:</span><br><span class="line">            print(str(res.status_code), <span class="string">":"</span> , imgUrl)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">"抛出异常："</span>, imgUrl)</span><br><span class="line">        print(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">with</span> open(filename, <span class="string">"wb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(res.content)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mkDir</span><span class="params">(dirName)</span>:</span></span><br><span class="line">    dirpath = os.path.join(sys.path[<span class="number">0</span>], dirName)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(dirpath):</span><br><span class="line">        os.mkdir(dirpath)</span><br><span class="line">    <span class="keyword">return</span> dirpath</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(<span class="string">"欢迎使用百度图片下载脚本！\n目前仅支持单个关键词。"</span>)</span><br><span class="line">    print(<span class="string">"下载结果保存在脚本目录下的results文件夹中。"</span>)</span><br><span class="line">    print(<span class="string">"="</span> * <span class="number">50</span>)</span><br><span class="line">    word = input(<span class="string">"请输入你要下载的图片关键词：\n"</span>)</span><br><span class="line"></span><br><span class="line">    dirpath = mkDir(<span class="string">"results"</span>)</span><br><span class="line"></span><br><span class="line">    urls = buildUrls(word)</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">        print(<span class="string">"正在请求："</span>, url)</span><br><span class="line">        html = requests.get(url, timeout=<span class="number">10</span>).content.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        imgUrls = resolveImgUrl(html)</span><br><span class="line">        <span class="keyword">if</span> len(imgUrls) == <span class="number">0</span>:  <span class="comment"># 没有图片则结束</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> imgUrls:</span><br><span class="line">            <span class="keyword">if</span> downImg(url, dirpath, str(index) + <span class="string">".jpg"</span>):</span><br><span class="line">                index += <span class="number">1</span></span><br><span class="line">                print(<span class="string">"已下载 %s 张"</span> % index)</span><br></pre></td></tr></table></figure></p>
<p>执行脚本：<br><img src="http://7xo8t2.com1.z0.glb.clouddn.com/img/%E7%BC%96%E7%A8%8B/Python/Python%203%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E5%8D%95%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%BB%93%E6%9E%9C.png" alt="单线程下载结果"></p>
<p>查看同目录下的results文件夹，又看到了亲切的「他」。</p>
<h2 id="多线程下载脚本">多线程下载脚本</h2><p>上面的代码仍然有改进空间：</p>
<ol>
<li>从JSON数据看，该关键词相关的图片有一千多张，单线程下载太慢了，时间都花在网络和硬盘IO上。加上多线程可以大大提升效率。</li>
<li>既然1中已经获取到图片总数，那么网址的无限容量生成器可以改成list，方便添加多线程。</li>
</ol>
<p>多线程一直没学好，想不到更优雅的写法，大家将就看一下吧，欢迎提出改进建议。</p>
<p>百度图片下载脚本之多线程版：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author: loveNight</span></span><br><span class="line"><span class="comment"># @Date:   2015-10-28 19:59:24</span></span><br><span class="line"><span class="comment"># @Last Modified by:   loveNight</span></span><br><span class="line"><span class="comment"># @Last Modified time: 2015-11-15 19:24:57</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime <span class="keyword">as</span> dt</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaiduImgDownloader</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"""百度图片下载工具，目前只支持单个关键词"""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解码网址用的映射表</span></span><br><span class="line">    str_table = &#123;</span><br><span class="line">        <span class="string">'_z2C$q'</span>: <span class="string">':'</span>,</span><br><span class="line">        <span class="string">'_z&amp;e3B'</span>: <span class="string">'.'</span>,</span><br><span class="line">        <span class="string">'AzdH3F'</span>: <span class="string">'/'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    char_table = &#123;</span><br><span class="line">        <span class="string">'w'</span>: <span class="string">'a'</span>,</span><br><span class="line">        <span class="string">'k'</span>: <span class="string">'b'</span>,</span><br><span class="line">        <span class="string">'v'</span>: <span class="string">'c'</span>,</span><br><span class="line">        <span class="string">'1'</span>: <span class="string">'d'</span>,</span><br><span class="line">        <span class="string">'j'</span>: <span class="string">'e'</span>,</span><br><span class="line">        <span class="string">'u'</span>: <span class="string">'f'</span>,</span><br><span class="line">        <span class="string">'2'</span>: <span class="string">'g'</span>,</span><br><span class="line">        <span class="string">'i'</span>: <span class="string">'h'</span>,</span><br><span class="line">        <span class="string">'t'</span>: <span class="string">'i'</span>,</span><br><span class="line">        <span class="string">'3'</span>: <span class="string">'j'</span>,</span><br><span class="line">        <span class="string">'h'</span>: <span class="string">'k'</span>,</span><br><span class="line">        <span class="string">'s'</span>: <span class="string">'l'</span>,</span><br><span class="line">        <span class="string">'4'</span>: <span class="string">'m'</span>,</span><br><span class="line">        <span class="string">'g'</span>: <span class="string">'n'</span>,</span><br><span class="line">        <span class="string">'5'</span>: <span class="string">'o'</span>,</span><br><span class="line">        <span class="string">'r'</span>: <span class="string">'p'</span>,</span><br><span class="line">        <span class="string">'q'</span>: <span class="string">'q'</span>,</span><br><span class="line">        <span class="string">'6'</span>: <span class="string">'r'</span>,</span><br><span class="line">        <span class="string">'f'</span>: <span class="string">'s'</span>,</span><br><span class="line">        <span class="string">'p'</span>: <span class="string">'t'</span>,</span><br><span class="line">        <span class="string">'7'</span>: <span class="string">'u'</span>,</span><br><span class="line">        <span class="string">'e'</span>: <span class="string">'v'</span>,</span><br><span class="line">        <span class="string">'o'</span>: <span class="string">'w'</span>,</span><br><span class="line">        <span class="string">'8'</span>: <span class="string">'1'</span>,</span><br><span class="line">        <span class="string">'d'</span>: <span class="string">'2'</span>,</span><br><span class="line">        <span class="string">'n'</span>: <span class="string">'3'</span>,</span><br><span class="line">        <span class="string">'9'</span>: <span class="string">'4'</span>,</span><br><span class="line">        <span class="string">'c'</span>: <span class="string">'5'</span>,</span><br><span class="line">        <span class="string">'m'</span>: <span class="string">'6'</span>,</span><br><span class="line">        <span class="string">'0'</span>: <span class="string">'7'</span>,</span><br><span class="line">        <span class="string">'b'</span>: <span class="string">'8'</span>,</span><br><span class="line">        <span class="string">'l'</span>: <span class="string">'9'</span>,</span><br><span class="line">        <span class="string">'a'</span>: <span class="string">'0'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    re_objURL = re.compile(<span class="string">r'"objURL":"(.*?)".*?"type":"(.*?)"'</span>)</span><br><span class="line">    re_downNum = re.compile(<span class="string">r"已下载\s(\d+)\s张图片"</span>)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.71 Safari/537.36"</span>,</span><br><span class="line">        <span class="string">"Accept-Encoding"</span>: <span class="string">"gzip, deflate, sdch"</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, word, dirpath=None, processNum=<span class="number">30</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">" "</span> <span class="keyword">in</span> word:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">"本脚本仅支持单个关键字"</span>)</span><br><span class="line">        self.word = word</span><br><span class="line">        self.char_table = &#123;ord(key): ord(value)</span><br><span class="line">                           <span class="keyword">for</span> key, value <span class="keyword">in</span> BaiduImgDownloader.char_table.items()&#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> dirpath:</span><br><span class="line">            dirpath = os.path.join(sys.path[<span class="number">0</span>], <span class="string">'results'</span>)</span><br><span class="line">        self.dirpath = dirpath</span><br><span class="line">        self.jsonUrlFile = os.path.join(sys.path[<span class="number">0</span>], <span class="string">'jsonUrl.txt'</span>)</span><br><span class="line">        self.logFile = os.path.join(sys.path[<span class="number">0</span>], <span class="string">'logInfo.txt'</span>)</span><br><span class="line">        self.errorFile = os.path.join(sys.path[<span class="number">0</span>], <span class="string">'errorUrl.txt'</span>)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(self.errorFile):</span><br><span class="line">            os.remove(self.errorFile)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(self.dirpath):</span><br><span class="line">            os.mkdir(self.dirpath)</span><br><span class="line">        self.pool = Pool(<span class="number">30</span>)</span><br><span class="line">        self.session = requests.Session()</span><br><span class="line">        self.session.headers = BaiduImgDownloader.headers</span><br><span class="line">        self.queue = Queue()</span><br><span class="line">        self.messageQueue = Queue()</span><br><span class="line">        self.index = <span class="number">0</span> <span class="comment"># 图片起始编号，牵涉到计数，不要更改</span></span><br><span class="line">        self.promptNum = <span class="number">10</span> <span class="comment"># 下载几张图片提示一次</span></span><br><span class="line">        self.lock = threading.Lock()</span><br><span class="line">        self.delay = <span class="number">1.5</span>  <span class="comment"># 网络请求太频繁会被封</span></span><br><span class="line">        self.QUIT = <span class="string">"QUIT"</span>  <span class="comment"># Queue中表示任务结束</span></span><br><span class="line">        self.printPrefix = <span class="string">"**"</span> <span class="comment"># 用于指定在控制台输出</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 控制台输出线程</span></span><br><span class="line">        t = threading.Thread(target=self.__log)</span><br><span class="line">        t.setDaemon(<span class="keyword">True</span>)</span><br><span class="line">        t.start()</span><br><span class="line">        self.messageQueue.put(self.printPrefix + <span class="string">"脚本开始执行"</span>)</span><br><span class="line">        start_time = dt.now()</span><br><span class="line">        urls = self.__buildUrls()</span><br><span class="line">        self.messageQueue.put(self.printPrefix + <span class="string">"已获取 %s 个Json请求网址"</span> % len(urls))</span><br><span class="line">        <span class="comment"># 解析出所有图片网址，该方法会阻塞直到任务完成</span></span><br><span class="line">        self.pool.map(self.__resolveImgUrl, urls)</span><br><span class="line">        <span class="keyword">while</span> self.queue.qsize():</span><br><span class="line">            imgs = self.queue.get()</span><br><span class="line">            self.pool.map_async(self.__downImg, imgs)</span><br><span class="line">        self.pool.close()</span><br><span class="line">        self.pool.join()</span><br><span class="line">        self.messageQueue.put(self.printPrefix + <span class="string">"下载完成！已下载 %s 张图片，总用时 %s"</span> %</span><br><span class="line">                              (self.index, dt.now() - start_time))</span><br><span class="line">        self.messageQueue.put(self.printPrefix + <span class="string">"请到 %s 查看结果！"</span> % self.dirpath)</span><br><span class="line">        self.messageQueue.put(self.printPrefix + <span class="string">"错误信息保存在 %s"</span> % self.errorFile)</span><br><span class="line">        self.messageQueue.put(self.QUIT)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__log</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""控制台输出，加锁以免被多线程打乱"""</span></span><br><span class="line">        <span class="keyword">with</span> open(self.logFile, <span class="string">"w"</span>, encoding = <span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">                message = self.messageQueue.get()</span><br><span class="line">                <span class="keyword">if</span> message == self.QUIT:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                message = str(dt.now()) + <span class="string">" "</span> + message</span><br><span class="line">                <span class="keyword">if</span> self.printPrefix  <span class="keyword">in</span> message:</span><br><span class="line">                    print(message)</span><br><span class="line">                <span class="keyword">elif</span> <span class="string">"已下载"</span> <span class="keyword">in</span> message:</span><br><span class="line">                    <span class="comment"># 下载N张图片提示一次</span></span><br><span class="line">                    downNum = self.re_downNum.findall(message)</span><br><span class="line">                    <span class="keyword">if</span> downNum <span class="keyword">and</span> int(downNum[<span class="number">0</span>]) % self.promptNum == <span class="number">0</span>:</span><br><span class="line">                        print(message)</span><br><span class="line">                f.write(message + <span class="string">'\n'</span>)</span><br><span class="line">                f.flush()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getIndex</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""获取文件编号"""</span></span><br><span class="line">        self.lock.acquire()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self.index</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self.index += <span class="number">1</span></span><br><span class="line">            self.lock.release()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        <span class="string">"""解码图片URL</span><br><span class="line">        解码前：</span><br><span class="line">        ippr_z2C$qAzdH3FAzdH3Ffl_z&amp;e3Bftgwt42_z&amp;e3BvgAzdH3F4omlaAzdH3Faa8W3ZyEpymRmx3Y1p7bb&amp;mla</span><br><span class="line">        解码后：</span><br><span class="line">        http://s9.sinaimg.cn/mw690/001WjZyEty6R6xjYdtu88&amp;690</span><br><span class="line">        """</span></span><br><span class="line">        <span class="comment"># 先替换字符串</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> self.str_table.items():</span><br><span class="line">            url = url.replace(key, value)</span><br><span class="line">        <span class="comment"># 再替换剩下的字符</span></span><br><span class="line">        <span class="keyword">return</span> url.translate(self.char_table)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__buildUrls</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""json请求网址生成器"""</span></span><br><span class="line">        word = urllib.parse.quote(self.word)</span><br><span class="line">        url = <span class="string">r"http://image.baidu.com/search/acjson?tn=resultjson_com&amp;ipn=rj&amp;ct=201326592&amp;fp=result&amp;queryWord=&#123;word&#125;&amp;cl=2&amp;lm=-1&amp;ie=utf-8&amp;oe=utf-8&amp;st=-1&amp;ic=0&amp;word=&#123;word&#125;&amp;face=0&amp;istype=2nc=1&amp;pn=&#123;pn&#125;&amp;rn=60"</span></span><br><span class="line">        time.sleep(self.delay)</span><br><span class="line">        html = self.session.get(url.format(word=word, pn=<span class="number">0</span>), timeout = <span class="number">15</span>).content.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        results = re.findall(<span class="string">r'"displayNum":(\d+),'</span>, html)</span><br><span class="line">        maxNum = int(results[<span class="number">0</span>]) <span class="keyword">if</span> results <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        urls = [url.format(word=word, pn=x)</span><br><span class="line">                <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, maxNum + <span class="number">1</span>, <span class="number">60</span>)]</span><br><span class="line">        <span class="keyword">with</span> open(self.jsonUrlFile, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">                f.write(url + <span class="string">"\n"</span>)</span><br><span class="line">        <span class="keyword">return</span> urls</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__resolveImgUrl</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        <span class="string">"""从指定网页中解析出图片URL"""</span></span><br><span class="line">        time.sleep(self.delay)</span><br><span class="line">        html = self.session.get(url, timeout = <span class="number">15</span>).content.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        datas = self.re_objURL.findall(html)</span><br><span class="line">        imgs = [Image(self.decode(x[<span class="number">0</span>]), x[<span class="number">1</span>]) <span class="keyword">for</span> x <span class="keyword">in</span> datas]</span><br><span class="line">        self.messageQueue.put(self.printPrefix + <span class="string">"已解析出 %s 个图片网址"</span> % len(imgs))</span><br><span class="line">        self.queue.put(imgs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__downImg</span><span class="params">(self, img)</span>:</span></span><br><span class="line">        <span class="string">"""下载单张图片，传入的是Image对象"""</span></span><br><span class="line">        imgUrl = img.url</span><br><span class="line">        <span class="comment"># self.messageQueue.put("线程 %s 正在下载 %s " %</span></span><br><span class="line">        <span class="comment">#          (threading.current_thread().name, imgUrl))</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            time.sleep(self.delay)</span><br><span class="line">            res = self.session.get(imgUrl, timeout = <span class="number">15</span>)</span><br><span class="line">            message = <span class="keyword">None</span></span><br><span class="line">            <span class="keyword">if</span> str(res.status_code)[<span class="number">0</span>] == <span class="string">"4"</span>:</span><br><span class="line">                message = <span class="string">"\n%s： %s"</span> % (res.status_code, imgUrl)</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">"text/html"</span> <span class="keyword">in</span> res.headers[<span class="string">"Content-Type"</span>]:</span><br><span class="line">                message = <span class="string">"\n无法打开图片： %s"</span> % imgUrl</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            message = <span class="string">"\n抛出异常： %s\n%s"</span> % (imgUrl, str(e))</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="keyword">if</span> message:</span><br><span class="line">                self.messageQueue.put(message)</span><br><span class="line">                self.__saveError(message)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        index = self.__getIndex()</span><br><span class="line">        <span class="comment"># index从0开始</span></span><br><span class="line">        self.messageQueue.put(<span class="string">"已下载 %s 张图片：%s"</span> % (index + <span class="number">1</span>, imgUrl))</span><br><span class="line">        filename = os.path.join(self.dirpath, str(index) + <span class="string">"."</span> + img.type)</span><br><span class="line">        <span class="keyword">with</span> open(filename, <span class="string">"wb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(res.content)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__saveError</span><span class="params">(self, message)</span>:</span></span><br><span class="line">        self.lock.acquire()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> open(self.errorFile, <span class="string">"a"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(message)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self.lock.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Image</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"""图片类，保存图片信息"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url, type)</span>:</span></span><br><span class="line">        super(Image, self).__init__()</span><br><span class="line">        self.url = url</span><br><span class="line">        self.type = type</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(<span class="string">"欢迎使用百度图片下载脚本！\n目前仅支持单个关键词。"</span>)</span><br><span class="line">    print(<span class="string">"下载结果保存在脚本目录下的results文件夹中。"</span>)</span><br><span class="line">    print(<span class="string">"="</span> * <span class="number">50</span>)</span><br><span class="line">    word = input(<span class="string">"请输入你要下载的图片关键词：\n"</span>)</span><br><span class="line">    down = BaiduImgDownloader(word)</span><br><span class="line">    down.start()</span><br></pre></td></tr></table></figure></p>
<p>执行脚本：</p>
<pre><code>欢迎使用百度图片下载脚本！
目前仅支持单个关键词。
下载结果保存在脚本目录下的results文件夹中。
==================================================
请输入你要下载的图片关键词：
长者蛤
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">11.726878</span> **脚本开始执行
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">16.292022</span> **已获取 <span class="number">20</span> 个Json请求网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">17.885767</span> **已解析出 <span class="number">30</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">17.917020</span> **已解析出 <span class="number">60</span> 个图片网址
.....
.....中间省略
.....
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">33</span>:<span class="number">31.726739</span> 已下载 <span class="number">980</span> 张图片：http:<span class="comment">//bbs.nantaihu.com/bbs/UpImages2008/2010/8/3/U97946_201083171218512-2.jpg</span>
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">33</span>:<span class="number">32.695518</span> 已下载 <span class="number">990</span> 张图片：http:<span class="comment">//pf.u.51img1.com/f9/7f/huangbaoling0_180.gif?v=20120224161006</span>
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">33</span>:<span class="number">45.473957</span> 已下载 <span class="number">1000</span> 张图片：http:<span class="comment">//library.taiwanschoolnet.org/cyberfair2003/C0312970394/narrative.files/image018.jpg</span>
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">33</span>:<span class="number">50.749544</span> **下载完成！已下载 <span class="number">1000</span> 张图片，总用时 <span class="number">0</span>:<span class="number">08</span>:<span class="number">39.022666</span>
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">33</span>:<span class="number">50.765169</span> **请到 F:\PythonWorkspace\Learn\results 查看结果！
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">33</span>:<span class="number">50.858880</span> **错误信息保存在 F:\PythonWorkspace\Learn\errorUrl.txt
</code></pre><p>合租室友太多，平时网速很慢，经常连百度都打不开，要刷新多次。下午测试的时候可以2分钟下完，现在居然要近9分钟。</p>
<p><code>errorUrl.txt</code>的内容</p>
<pre><code>无法打开图片： http:<span class="comment">//s3.t.itc.cn/mblog/pic/20136_20_14/f_b3a1be1796819229739.png</span>
<span class="number">403</span>： http:<span class="comment">//www.longhoo.net/gb/longhoo/culture/view/images/00024483.jpg</span>
无法打开图片： http:<span class="comment">//bhyjk.cn/images/IMG44zj10.jpg</span>
<span class="number">404</span>： http:<span class="comment">//ebook.indaa.com.cn/upload/baike/images/2960001-2970000/2968900/adee30ddd41190838c10291d.jpg</span>
抛出异常： http:<span class="comment">//www.jzxzj.com/images/xs.jpg</span>
<span class="function"><span class="title">HTTPConnectionPool</span><span class="params">(host=<span class="string">'www.jzxzj.com'</span>, port=<span class="number">80</span>)</span></span>: Max retries exceeded with url: /images/xs<span class="class">.jpg</span> (Caused by <span class="function"><span class="title">NewConnectionError</span><span class="params">(<span class="string">'&lt;requests.packages.urllib3.connection.HTTPConnection object at 0x0851FBB0&gt;: Failed to establish a new connection: [Errno 11002] getaddrinfo failed'</span>,)</span></span>)
抛出异常： http:<span class="comment">//static.acfun.mm111.net/h/image/20147/846b7553851b6edb2305c6b87f4aed71.jpg</span>
<span class="function"><span class="title">HTTPConnectionPool</span><span class="params">(host=<span class="string">'static.acfun.mm111.net'</span>, port=<span class="number">80</span>)</span></span>: Max retries exceeded with url: /h/image/<span class="number">20147</span>/<span class="number">846</span>b7553851b6edb2305c6b87f4aed71<span class="class">.jpg</span> (Caused by <span class="function"><span class="title">NewConnectionError</span><span class="params">(<span class="string">'&lt;requests.packages.urllib3.connection.HTTPConnection object at 0x0888B710&gt;: Failed to establish a new connection: [Errno 11001] getaddrinfo failed'</span>,)</span></span>)
抛出异常： http:<span class="comment">//static.acfun.mm111.net/h/image/2015-0-4/23ebeaf5-5130-4072-b90e-48ce4d122ac8.jpg</span>
<span class="function"><span class="title">HTTPConnectionPool</span><span class="params">(host=<span class="string">'static.acfun.mm111.net'</span>, port=<span class="number">80</span>)</span></span>: Max retries exceeded with url: /h/image/<span class="number">2015</span>-<span class="number">0</span>-<span class="number">4</span>/<span class="number">23</span>ebeaf5-<span class="number">5130</span>-<span class="number">4072</span>-b90e-<span class="number">48</span>ce4d122ac8<span class="class">.jpg</span> (Caused by <span class="function"><span class="title">NewConnectionError</span><span class="params">(<span class="string">'&lt;requests.packages.urllib3.connection.HTTPConnection object at 0x0888F1F0&gt;: Failed to establish a new connection: [Errno 11001] getaddrinfo failed'</span>,)</span></span>)
<span class="number">404</span>： http:<span class="comment">//www.zipooo.com/tupian/1/%CE%EF%C1%F7%BF%EC%B5%DD.gif</span>
无法打开图片： http:<span class="comment">//www.zhiyin.cn/hsbk/fakeimg/7939883.jpeg</span>
无法打开图片： http:<span class="comment">//www.zhiyin.cn/hsbk/fakeimg/21753396.jpeg</span>
.....
</code></pre><p><code>logInfo.txt</code>内容：</p>
<pre><code><span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">11.726878</span> **脚本开始执行
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">16.292022</span> **已获取 <span class="number">20</span> 个Json请求网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">17.885767</span> **已解析出 <span class="number">30</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">17.917020</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">17.948262</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">17.963895</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">17.995146</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.010769</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.057638</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.057638</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.073264</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.073264</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.088890</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.088890</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.104516</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.104516</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.104516</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.104516</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.245137</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.260764</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.260764</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">18.479555</span> **已解析出 <span class="number">60</span> 个图片网址
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">27.532965</span> 已下载 <span class="number">1</span> 张图片：http:<span class="comment">//imgsrc.baidu.com/baike/abpic/item/43e6c7335b379350ad4b5f92.jpg</span>
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">29.084964</span>
无法打开图片： http:<span class="comment">//s3.t.itc.cn/mblog/pic/20136_20_14/f_b3a1be1796819229739.png</span>
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">29.522473</span> 已下载 <span class="number">2</span> 张图片：http:<span class="comment">//p4.qhimg.com/dr/200_200_/t0196ad8cefbc7a2c7c.jpg</span>
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">29.822650</span> 已下载 <span class="number">3</span> 张图片：http:<span class="comment">//library.taiwanschoolnet.org/cyberfair2003/C0312970394/narrative.files/image016.jpg</span>
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">29.938687</span> 已下载 <span class="number">4</span> 张图片：http:<span class="comment">//blog.ylib.com/public/Utilities/ImageReader.aspx?/0/6/06c67eaf-09db-40a8-a117-c577a6d05d08.jpg</span>
....
</code></pre><p>仍然可以改进的地方：</p>
<ol>
<li>如果要搜索多个关键词，buildUrls方法应该怎么改？</li>
<li>如果脚本中途意外结束（比如被熊孩子点了X），如何继续下载？</li>
<li>线程池中的线程数需要多次测试才能找到最优值。</li>
</ol>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程/">编程</a>►<a class="article-category-link" href="/categories/编程/Python/">Python</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Python/">Python</a><a href="/tags/多线程/">多线程</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://lovenight.github.io/2015/11/15/Python-3-多线程下载百度图片搜索结果/" data-title="Python 3 多线程下载百度图片搜索结果 | 岁月如歌" data-tsina="1069913250" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2015/11/14/Python-3-json与正则式解析速度测试/"  title="Python 3 json与正则式解析速度测试">
 <strong>下一篇：</strong><br/> 
 <span>Python 3 json与正则式解析速度测试
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2015/11/15/Python-3-多线程下载百度图片搜索结果/" data-title="Python 3 多线程下载百度图片搜索结果" data-url="http://lovenight.github.io/2015/11/15/Python-3-多线程下载百度图片搜索结果/"></div>
</section>


</div>  

      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#下载简单页面"><span class="toc-number">1.</span> <span class="toc-text">下载简单页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载更多图片"><span class="toc-number">2.</span> <span class="toc-text">加载更多图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#单线程下载脚本"><span class="toc-number">3.</span> <span class="toc-text">单线程下载脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多线程下载脚本"><span class="toc-number">4.</span> <span class="toc-text">多线程下载脚本</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/编程/Python/" title="Python">Python<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程/hexo/" title="hexo">hexo<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程/" title="编程">编程<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/随笔/" title="随笔">随笔<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/hexo/" title="hexo">hexo<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/黑板客/" title="黑板客">黑板客<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/爬虫/" title="爬虫">爬虫<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/多线程/" title="多线程">多线程<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/知乎/" title="知乎">知乎<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/正则表达式/" title="正则表达式">正则表达式<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/timeit/" title="timeit">timeit<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/RecursionError/" title="RecursionError">RecursionError<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Queue/" title="Queue">Queue<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/json/" title="json">json<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://blog.csdn.net/kinglearnjava" target="_blank" title="我的CSDN博客">我的CSDN博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://blog.sina.com.cn/u/1069913250" target="_blank" title="我的新浪博客">我的新浪博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.douban.com/people/songlet/photos" target="_blank" title="宋乐天的相册">宋乐天的相册</a>
            
          </li>
        
    </ul>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 自古求真皆寂寞，惟挑心灯伴夜霭。 <br/>
			The night is yet young.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/king881204" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/loveNight" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		<a href="mailto:286242151@qq.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		


		<p class="copyright">

		2015年11月9日诞生，<span id="showDays"></span>&nbsp;&nbsp;|&nbsp;
		本页点击量 <span id="busuanzi_value_page_pv"></span> 次&nbsp;&nbsp;|&nbsp;
		本站总点击量 <span id="busuanzi_value_site_pv"></span> 次&nbsp;&nbsp;|&nbsp;
		您是第 <span id="busuanzi_value_site_uv"></span> 位访客
		</br>

		<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
		</script>
		<script>
		var birthDay = new Date("11/9/2015");
		var now = new Date();
		var duration = now.getTime() - birthDay.getTime();
		var total= Math.floor(duration / (1000 * 60 * 60 * 24));
		document.getElementById("showDays").innerHTML = "已运行 "+total+" 天";
		</script>

		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2015
		
		<a href="/about" target="_blank" title="LoveNight">LoveNight</a>
		


		&nbsp;&nbsp;|&nbsp;&nbsp;<span><a href="/sitemap.xml">Google网站地图</a></span>
		&nbsp;&nbsp;|&nbsp;&nbsp;<span><a href="/baidusitemap.xml">百度网站地图</a></span>

		<script>
		(function(){
		    var bp = document.createElement('script');
		    bp.src = '//push.zhanzhang.baidu.com/push.js';
		    var s = document.getElementsByTagName("script")[0];
		    s.parentNode.insertBefore(bp, s);
		})();
		</script>

		</p>



</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"jwg"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-69840176-1', 'http://lovenight.github.io/');  
ga('send', 'pageview');
</script>





<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1256738554'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1256738554' type='text/javascript'%3E%3C/script%3E"));</script>

<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
